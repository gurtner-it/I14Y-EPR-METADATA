<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>I14Y XML/JSON Transformer & API Upload</title>
    <link rel="stylesheet" href="app.css">
</head>
<body>
    <div class="container">
        <!-- Modern Toggle Switch -->
        <div class="env-toggle">
            <input type="radio" id="env-abn" name="environment" value="ABN" checked>
            <label for="env-abn">ABN</label>

            <input type="radio" id="env-prod" name="environment" value="PROD">
            <label for="env-prod">PROD</label>

            <span class="toggle-bg"></span>
        </div>


        <div class="header">   

            <h1>I14Y Transformer & API</h1>
            <p>Transform XML to JSON and upload to I14Y API</p>

        </div>

        <div class="main-content">
           <div class="tabs">
                <button class="tab active" data-tab="transform" onclick="switchTab('transform')">Transform Files</button>
                <button class="tab" data-tab="api" onclick="switchTab('api')">API Operations</button>
                <button class="tab" data-tab="short-readme" onclick="switchTab('short-readme')">Short readme</button>
                <button class="tab" data-tab="readme" onclick="switchTab('readme')">readme.md</button>
                <button class="tab" data-tab="api_errors" onclick="switchTab('api_errors')">API Error Log</button>
            </div>

            <!-- Transform Tab -->
            <div id="transform" class="tab-content active">
                <div class="info-box">
                    <h3>File Transformation</h3>
                    <p>Upload XML files to transform them into I14Y JSON format. Fill in the required metadata and select your files.</p>
                </div>

                <form id="transformForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="responsibleKey">Responsible Key *</label>
                            <input type="text" id="responsibleKey" name="responsibleKey" placeholder="e.g., PGR" value="PGR" required>
                        </div>
                        <div class="form-group">
                            <label for="deputyKey">Deputy Key *</label>
                            <input type="text" id="deputyKey" name="deputyKey" placeholder="e.g., SNE" value="SNE" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="dateValidFrom">Date Valid From *</label>
                        <input type="date" id="dateValidFrom" name="dateValidFrom" required>
                    </div>

                    <div class="form-group">
                        <label for="version">Version *</label>
                        <input type="text" id="version" name="version" placeholder="e.g., 2.0.3" value="1.0.0" required>
                        <small id="version-status" style="color: #666; display: block; margin-top: 4px;">‚ö†Ô∏è Please increment version before transforming</small>
                    </div>

                    <div class="form-group" style="display:none">
                        <div class="checkbox-group">
                            <input type="checkbox" id="createNew" name="createNew">
                            <label for="createNew">Create new concept (not recommended! Should if possible always create a new version of a concept)</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="files">Select Files (XML)</label>
                        <div class="file-upload">
                            <input type="file" id="files" multiple accept=".xml" onchange="handleFileSelect(event)">
                            <label for="files" class="file-upload-label">
                                üìÅ Choose Files or Drag & Drop
                            </label>
                        </div>
                        <div id="fileList" class="file-list">
                            <span style="color: #999;">No files selected</span>
                        </div>
                    </div>

                    <button type="submit" class="btn">Transform Files</button>
                </form>
            </div>

            <!-- API Tab -->
            <div id="api" class="tab-content">
                <div class="info-box">
                    <h3>API Operations</h3>
                    <p>Perform various operations with the I14Y API including uploading concepts, managing codelists, and retrieving data.</p>
                </div>

                <form id="apiForm">
                    <div class="form-group">
                        <label for="apiMethod">API Method *</label>
                        <select id="apiMethod" name="apiMethod" onchange="updateApiForm()" required>
                            <option value="">Select an operation...</option>
                            <optgroup label="Upload Operations">
                                <option value="-pc">Post New Concept</option>
                                <option value="-pmc">Post Multiple Concepts</option>
                                <option value="-pcl">Post Codelist Entries</option>
                                <option value="-pmcl">Post Multiple Codelists</option>
                            </optgroup>
                            <optgroup label="Get Operations">
                                <option value="-gc">Get Concepts</option>
                                <option value="-gec">Get EPD Concepts</option>
                                <option value="-gci">Get Concept by identifier (OID)</option>
                                <option value="-gce">Get Codelist Entry</option>
                            </optgroup>
                            <optgroup label="Status & Publication level Methods:">
                                <option value="-spl">Set publication level of a concept</option>
                                <option value="-srs">Set registration status of concept (proposal)</option>
                            </optgroup>
                            <optgroup label="Update/Delete">
                                <option value="-ucl">Update Codelist Entries (Delete & Post)</option>
                                <option value="-dcl">Delete Codelist Entries</option>
                                <option value="-dc">Delete Concept (CAVE: Should not be done, instead post a new concept and change status)</option>
                                <option value="-ucm">Update Codelist Mapping</option>
                            </optgroup>
                        </select>
                    </div>

                    <div id="apiParameters"></div>

                    <button type="submit" class="btn">Execute API Call</button>
                </form>
            </div>

            <div id="readme" class="tab-content"></div>

            <div id="api_errors" class="tab-content">
                <button type="submit" class="btn" onclick="emptyApiErrors()">Empty log</button>
            </div>

            <!-- Short GUI Readme -->
<div id="short-readme" class="tab-content">
    <div class="info-box">
        <h3>üöÄ Complete Workflow (GUI)</h3>
        <p>
        Follow this step-by-step process to transform XML code lists and upload them to I14Y. 
        Always start in <b>ABN (test)</b> mode and switch to <b>PROD</b> once everything works.
        </p>
    </div>

    <ol>
        <li>
        <strong>Check your <code>.env</code> configuration</strong><br>
        - <code>API_MODE=ABN</code> (test first)<br>
        - <code>PROD</code> only once verified<br>
        - Fill in your <code>CLIENT_ID</code>, <code>CLIENT_SECRET</code>, 
            and token URLs (see README.md for exact variables).
        </li>

        <li>
        <strong>Step 1: Transform XML ‚Üí JSON</strong><br>
        In the GUI, choose the <b>Transform Files</b> tab.  
        Your XML files from <code>AD_VS/XML</code> will be converted into I14Y-compliant JSON 
        and saved under <code>AD_VS/Transformed/Concepts</code> and <code>AD_VS/Transformed/Codelists</code>.
        <p class="hint">
        ‚úÖ <strong>Version Management (Important!):</strong><br>
        ‚Ä¢ When you select XML files, the system automatically fetches the <strong>current version</strong> from I14Y<br>
        ‚Ä¢ <strong>You must increment the version</strong> before transforming (e.g., 2.0.2 ‚Üí 2.0.3)<br>
        ‚Ä¢ For new concepts: Start with <code>1.0.0</code><br>
        ‚Ä¢ For updates: Increment major (3.0.0), minor (2.1.0), or patch (2.0.1) as needed<br>
        ‚Ä¢ If API fetch fails, default is <code>1.0.0</code>
        </p>
        <p class="hint">This automatically creates both concept definitions and their code lists.</p>
        </li>

        <li>
        <strong>Step 2: Upload Concept Versions</strong><br>
        In the GUI, select <b>Post Concept</b>.  
        Use the transformed concept JSON files from <code>AD_VS/Transformed/Concepts</code> as input.  
        This creates new concept versions in the chosen environment (ABN or PROD).
        </li>

        <li>
        <strong>Step 3: Upload Code Lists</strong><br>
        In the GUI, select <b>Post Codelist</b>.  
        Use the transformed codelist JSON files from <code>AD_VS/Transformed/Codelists</code> as input.  
        This adds code list entries to the previously uploaded concepts.
        </li>

        <li>
        <strong>Step 4: Set Registration Status to "Recorded"</strong><br>
        Still in the GUI, choose <b>Set Registration Status</b> and change to <code>Recorded</code>.
        <p class="hint">
        Common statuses: <b>Recorded</b> (official), <b>Retired</b> (obsolete). 
        <b>Standard</b> status can only be set by I14Y support.
        </p>
        </li>

        <li>
        <strong>Step 5: Verify via I14Y Web Platform</strong><br>
        Open the official I14Y portal and confirm your concepts are published correctly:
        <br>‚Ä¢ <b>ABN:</b> <a href="https://www.i14y-a.admin.ch" target="_blank">https://www.i14y-a.admin.ch</a>
        <br>‚Ä¢ <b>PROD:</b> <a href="https://input.i14y.admin.ch" target="_blank">https://input.i14y.admin.ch</a>
        <p class="hint">
        ‚úÖ Check: Status = "Recorded", Code lists present, Multilingual content correct
        </p>
        </li>

        <li>
        <strong>Deploy to Production</strong><br>
        Once everything looks correct in ABN, update your <code>.env</code> to 
        <code>API_MODE=PROD</code> and repeat Steps 2-5.
        </li>
    </ol>
</div>

<div id="output" class="output" style="display: none;">
    <div id="outputContent"></div>
</div>

<br/>
<label for="tokenInput"  style="margin-top:2em">Token for <a href="https://apiconsole.i14y.admin.ch/partner/v1/" target="_Blank">I14Y Swagger</a>:</label>
<input type="text" id="tokenInput" placeholder="Token will appear here" onclick="this.select()">

<div class="logos">
            <img src="img/ehs-logo.png">
            <img src="img/i14y-logo.png">
        </div>
    </div>

    <script src="app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>